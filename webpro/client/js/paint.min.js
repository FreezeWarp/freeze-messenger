/*
 Joseph T. Parsons 2017
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Object.assign",function(a){return a?a:function(a,c){for(var b=1;b<arguments.length;b++){var e=arguments[b];if(e)for(var f in e)$jscomp.owns(e,f)&&(a[f]=e[f])}return a}},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");
function $q(a,b){$("body").replaceWith(a);throw Error(b||a);}function $l(a,b,c){var d=!1,e="",f=!1;stringNameParts=a.split(".");$.each(stringNameParts,function(a,b){e+="['"+b+"']";if(void 0===eval("window.phrases"+e+" || extra"+e))return f=!0,!1});if(!1===f&&(d=eval("window.phrases"+e+" || extra"+e)))return b&&$.each(b,function(a,b){d=d.replace("{{{{"+a+"}}}}",b)}),d;console.log('Missing phrase "'+a+'"');return"~~"+a}
Handlebars.registerHelper("contains",function(a,b,c){b=b instanceof Array?b:[b];return-1<b.indexOf(a)?c.fn(this):""});function fim_renderHandlebarsInPlace(a){var b=a.attr("id"),c=a.html();c=Handlebars.compile(c);$("#active-"+b).remove();$('<div id="active-'+b+'">'+c(fim_getHandlebarsPhrases())+"</div>").insertAfter(a)}
function fim_renderHandlebars(a,b){var c=a.attr("id");a=a.html();a=Handlebars.compile(a);$("#active-"+c).remove();$(b).html($('<div id="active-'+c+'">'+a(fim_getHandlebarsPhrases())+"</div>"))}function fim_getHandlebarsPhrases(a){a||(a={});return Object.assign({},window.phrases,{serverSettings:window.serverSettings,activeLogin:window.activeLogin},a)}
function fim_openView(a,b){if($(".fim-activeView").attr("id")=="active-view-"+a)jQuery.each(b,function(b,d){b="set"+b.charAt(0).toUpperCase()+b.slice(1);if("undefined"!=typeof popup[a]&&"undefined"!=typeof popup[a][b])popup[a][b](d)}),"undefined"!=typeof popup[a].retrieve&&popup[a].retrieve();else if(tag=$("#view-"+a),0<tag.length)fim_closeView(),fim_renderHandlebars(tag,$("#content")),$("#active-view-"+a).addClass("fim-activeView"),"undefined"!=typeof popup[a]&&(popup[a].init(b),jQuery.each(b,function(b,
d){b="set"+b.charAt(0).toUpperCase()+b.slice(1);if("undefined"!=typeof popup[a]&&"undefined"!=typeof popup[a][b])popup[a][b](d)}),"undefined"!=typeof popup[a].retrieve&&popup[a].retrieve());else throw"Unknown view.";}function fim_closeView(){$(".fim-activeView").each(function(){var a=$(this).attr("id").slice(12);"undefined"!=typeof popup[a]&&"undefined"!=typeof popup[a].close&&popup[a].close(options);$(this).remove()})}
function fim_hashParse(a){var b=window.location.hash.split("#");a=Object.assign({},a);for(var c=0;c<b.length;c++){var d=b[c].split("=");2==d.length&&(a[d[0]]=d[1])}"room"in a||(a.room=window.roomId);a.roomId=a.room;b[1]?0<$("#view-"+b[1].split("=")[0]).length?fim_openView(b[1].split("=")[0],a):(console.log("no action",a),fim_openView("room",a)):fim_openView("room",a)}function fim_getHashRegex(a){return new RegExp("#"+a+"(=([^#]+))?(#|$)")}
function fim_setHashParameter(a,b){window.location.hash.match(fim_getHashRegex(a))?window.location.hash=window.location.hash.replace(fim_getHashRegex(a),"#"+a+"="+b+"$3"):window.location.hash+="#"+a+"="+b}function fim_removeHashParameter(a){window.location.hash=window.location.hash.replace(fim_getHashRegex(a),"")}
function fim_atomicRemoveHashParameterSetHashParameter(a,b,c){var d=window.location.hash;d=d.replace(fim_getHashRegex(a),"");d=d.match(fim_getHashRegex(b))?window.location.hash.replace(fim_getHashRegex(b),"#"+b+"="+c+"$3"):d+("#"+b+"="+c);window.location.hash=d}"undefined"===typeof Date?window.location.href="browser.html":"undefined"===typeof Math?window.location.href="browser.html":!1===("encodeURIComponent"in window||"escape"in window)&&(window.location.href="browser.html");
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c=this.length>>>0;b=Number(b)||0;b=0>b?Math.ceil(b):Math.floor(b);for(0>b&&(b+=c);b<c;b++)if(b in this&&this[b]===a)return b;return-1});Array.prototype.remove=function(a){return this.splice(this.indexOf(a),1)};if("object"!==typeof console||"function"!==typeof console.log)var console={log:function(){return!1},assert:function(){return!1}};var userId,roomId,sessionHash,anonId,prepopup,serverSettings;window.isBlurred=!1;
var favicon=$("#favicon").attr("href"),requestSettings={serverSentEvents:!1},timers={t1:!1},messageIndex={};window.webproDisplay={theme:$.getCookie("webpro_theme","absolution"),fontSize:$.getCookie("webpro_fontSize",1),settingsBitfield:$.getCookie("webpro_settings",50341888),audioVolume:$.getCookie("webpro_audioVolume",.5)};
if(1<window.webproDisplay.audioVolume||0>window.webproDisplay.audioVolume)console.error("audioVolume was "+window.webproDisplay.audioVolume+"; set to .5"),window.webproDisplay.audioVolume=.5;
if("undefined"!==typeof Audio){var snd=new Audio;null!==$.cookie("webpro_audioFile")?audioFile=$.cookie("webpro_audioFile"):snd.canPlayType("audio/ogg; codecs=vorbis")?audioFile="images/beep.ogg":snd.canPlayType("audio/mp3")?audioFile="images/beep.mp3":snd.canPlayType("audio/wav")?audioFile="images/beep.wav":(audioFile="",console.log("Audio Disabled"));snd.setAttribute("src",audioFile);snd.volume=window.webproDisplay.audioVolume}else snd={play:function(){return!1},volume:0};
var directory=window.location.pathname.split("/").splice(0,window.location.pathname.split("/").length-2).join("/")+"/",currentLocation=window.location.protocol+"//"+window.location.host+directory+"webpro/";
$.when($.ajax({url:"client/data/config.json",dataType:"json",success:function(a){window.fim_config=a}}),$.ajax({url:"client/data/language_enGB.json",dataType:"json",success:function(a){window.phrases=a}}),$.ajax({url:"client/js/fim-all.js",dataType:"script"}),$.ajax({url:window.directory+"api/serverStatus.php",dataType:"json",success:function(a){window.serverSettings=a.serverStatus}})).then(function(){window.fimApi=new fimApi;fimApi.registerDefaultExceptionHandler(function(a){dia.exception(a)});window.standard=
new standard;window.popup=new popup;window.serverSettings.installUrl!=window.location.protocol+"//"+window.location.host+window.directory&&dia.error(window.phrases.errorBadInstall);$(document).ready(function(){fim_renderHandlebarsInPlace($("#entry-template"));var a=function(a,b){dia.full({title:"Link to this Message",content:$("<span>").text("This message can be bookmarked using the following archive link:").append($("<br>"),$("<br>"),$("<input>").attr({type:"text",value:currentLocation+"#page=archive#room="+
a+"#message="+b,autofocus:!0,id:"messageLink-"+a+"-"+b,style:"width: 100%;"})).prop("outerHTML"),oF:function(){$("#messageLink-"+a+"-"+b).focus().select()}})},b=function(a,b){dia.confirm({text:"Are you sure you want to delete this message?","true":function(){standard.deleteMessage(a,b)}})},c=function(a){$("#message"+a+" .messageText").dblclick()},d={disabled:"bg-inverse",visible:"bg-primary",notSelectable:"not-selectable"};$.contextMenu({classNames:d,selector:".messageText",items:{delete:{name:"Delete",
callback:function(){b($(this).attr("data-roomid"),$(this).attr("data-messageid"))}},link:{name:"Link",callback:function(){a($(this).attr("data-roomid"),$(this).attr("data-messageid"))}},edit:{name:"Edit",callback:function(){c($(this).attr("data-messageid"))},visible:function(){return $(this).parent(".messageLine").find(".userName").attr("data-userid")==window.userId&&window.activeLogin.userData.permissions.editOwnPosts}}}});$.contextMenu({classNames:d,selector:".messageText img",items:{delete:{name:"Delete",
callback:function(){b($(this).closest(".messageText").attr("data-roomid"),$(this).closest(".messageText").attr("data-messageid"))}},link:{name:"Link",callback:function(){a($(this).closest(".messageText").attr("data-roomid"),$(this).closest(".messageText").attr("data-messageid"))}},edit:{name:"Edit",callback:function(){c($(this).closest(".messageText").attr("data-messageid"))},visible:function(){return $(this).closest(".messageLine").find(".userName").attr("data-userid")==window.userId&&window.activeLogin.userData.permissions.editOwnPosts}},
click:{name:"URL",callback:function(){dia.full({title:"Copy Image URL",content:$("<div>").append($("<img>").attr({src:$(this).attr("src"),style:"max-width: 550px; max-height: 550px; margin-left: auto; margin-right: auto; display: block;"}),$("<br>"),$("<br>"),$("<input>").attr({type:"text",name:"url",value:$(this).attr("src"),style:"width: 100%"})).prop("outerHTML"),width:800,position:"top",oF:function(){$("input[name=url]",this).first().focus()}})}}}});$.contextMenu({classNames:d,selector:".messageText a",
items:{delete:{name:"Delete",callback:function(){b($(this).closest(".messageText").attr("data-roomid"),$(this).closest(".messageText").attr("data-messageid"))}},link:{name:"Link",callback:function(){console.log($(this),$(this).closest(".messageText"),$(this).closest(".messageText").attr("data-roomid"));a($(this).closest(".messageText").attr("data-roomid"),$(this).closest(".messageText").attr("data-messageid"))}},edit:{name:"Edit",callback:function(){c($(this).closest(".messageText").attr("data-messageid"))},
visible:function(){return $(this).closest(".messageLine").find(".userName").attr("data-userid")==window.userId&&window.activeLogin.userData.permissions.editOwnPosts}},click:{name:"URL",callback:function(){dia.full({title:"Copy URL",position:"top",content:$("<input>").attr({type:"text",name:"url",value:$(this).attr("href"),style:"width: 100%;"}).prop("outerHTML"),width:800,oF:function(){$("input[name=url]",this).first().focus()}})}}}});$.contextMenu({classNames:d,selector:".userName",items:{profile:{name:"Profile",
callback:function(){$.when(Resolver.resolveUsersFromIds([userId])).then(function(a){dia.full({title:"User Profile",id:"messageLink",content:a[userId].profile?'<iframe src="'+a[userId].profile+'" style="width: 100%; height: 90%;" /><br /><a href="'+a[userId].profile+'" target="_BLANK">Visit The Page Directly</a>':"The user has not yet registered a profile.",width:.8*$(window).width(),height:.9*$(window).height()})})}},privateIm:{name:"Private IM",callback:function(){window.location.hash="#room=p"+
[window.userId,$(this).attr("data-userid")].join()},visible:function(){return $(this).attr("data-userid")!=window.userId}},kick:{name:"Kick",callback:function(){popup.kick($("data-userid"),window.roomId)},visible:function(){return!1}},ban:{name:"Ban",callback:function(){standard.banUser($("data-userid"))},visible:function(){return!1}},ignore:{name:"Ignore",callback:function(){dia.alert("This functionality is not yet implemented.")}}}});$("#privateRoomForm input[name=userName]").autocompleteHelper("users");
$("#privateRoomForm").submit(function(){console.log("form submitted");var a=$("#privateRoomForm input[name=userName]").val(),b=$("#privateRoomForm input[name=userName]").attr("data-id");whenUserIdAvailable=function(a){window.location.hash="#room=p"+[window.userId,a].join()};!b&&a?whenUserIdAvailable(b):a?$.when(Resolver.resolveUsersFromNames([a]).then(function(b){whenUserIdAvailable(b[a].id)})):dia.error("Please enter a username.");return!1});window.webproDisplay.fontSize&&$("body").css("font-size",
window.webproDisplay.fontSize+"em");settings.disableFx&&(jQuery.fx.off=!0);$(window).bind("resize",windowResize);$(window).bind("hashchange",fim_hashParse);document.addEventListener("visibilitychange",function(){"hidden"==document.visibilityState?windowBlur():windowFocus()});showLogin=function(){window.location.hash.match(/\#sessionHash=/)?standard.initialLogin({grantType:"access_token",sessionHash:window.location.hash.match(/\#sessionHash=([^\#]+)/)[1],error:function(){window.userId||popup.login()}}):
$.cookie("webpro_refreshToken")?standard.initialLogin({grantType:"refresh_token",refreshToken:$.cookie("webpro_refreshToken"),error:function(){window.userId||popup.login()}}):$.cookie("webpro_username")?standard.initialLogin({username:$.cookie("webpro_username"),password:$.cookie("webpro_password"),error:function(){window.userId||popup.login()}}):popup.login()};showLogin();return!1})},function(){$q("Loading failed. Please refresh.")});
