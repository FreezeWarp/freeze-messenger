var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var f=a[e];if(b.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,c={next:function(){if(d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.polyfill("Object.values",function(a){return a?a:function(a){var b=[],c;for(c in a)$jscomp.owns(a,c)&&b.push(a[c]);return b}},"es8","es3");var popup=function(){};
popup.prototype.login=function(){function a(a){$("#modal-login").modal("hide");a.userData.permissions.view?a.userData.permissions.post?dia.info("You are now logged in as "+a.userData.name+".","Logged In"):dia.info("You are now logged in as "+a.userData.name+". However, you are not allowed to post and have been silenced by an administrator. You may still view rooms which allow you access.","Logged In"):dia.info("You are now logged in as "+a.userData.name+". However, you are not allowed to view and have been banned by an administrator.",
"Logged In")}function b(a){switch(a.string){case "sessionMismatchUserId":case "sessionMismatchBrowser":case "sessionMismatchIp":case "invalidSession":dia.error("The server rejected the stored session. Please login.");break;case "loginRequired":dia.error("A valid login must be provided. Please login.");break;case "invalid_grant":dia.error("The login provided is not valid. You most likely entered an incorrect password.");break;default:dia.error("Unknown error logging in: "+a.string)}}$("#modal-login").modal();
$("#loginForm").submit(function(){var d=$("#loginForm");standard.initialLogin({username:$("input[name=userName]",d).val(),password:$("input[name=password]",d).val(),finish:a,error:b});return!1});$("#modal-login").on("hidden.bs.modal",function(){window.userId||standard.initialLogin({username:"",password:"",rememberMe:!1,finish:a,error:b})})};
popup.prototype.insertDoc=function(){$("#modal-insertDoc").modal();var a="",b=0,d="",c=[],e="";"fileUploads"in serverSettings?(serverSettings.fileUploads.extensionChangesReverse={},jQuery.each(serverSettings.fileUploads.extensionChanges,function(a,b){b in serverSettings.fileUploads.extensionChangesReverse||(serverSettings.fileUploads.extensionChangesReverse[b]=[b]);serverSettings.fileUploads.extensionChangesReverse[b].push(b)}),jQuery.each(serverSettings.fileUploads.allowedExtensions,function(a,b){a=
serverSettings.fileUploads.sizeLimits[b];var d=serverSettings.fileUploads.fileContainers[b],c=serverSettings.fileUploads.extensionChangesReverse[b];$("table#fileUploadInfo tbody").append("<tr><td>"+(c?c.join(", "):b)+"</td><td>"+$l("fileContainers."+d)+"</td><td>"+$.formatFileSize(a,$l("byteUnits"))+"</td></tr>")}),"function"!==typeof FileReader?$("#uploadFileForm").html($l("uploadErrors.notSupported")):(window.serverSettings.parentalControls.parentalEnabled?(jQuery.each(window.serverSettings.parentalControls.parentalAges,
function(a,b){$("form#uploadFileForm select[name=parentalAge]").append($("<option>").attr("value",b).text($l("parentalAges."+b)))}),jQuery.each(window.serverSettings.parentalControls.parentalFlags,function(a,b){$("form#uploadFileForm [name=parentalFlagsList]").append($("<label>").attr("class","btn btn-secondary").text($l("parentalFlags."+b)).append($("<input>").attr({type:"checkbox",value:b,name:"parentalFlags"})))})):$("#insertDocParentalAge, #insertDocParentalFlags").remove(),$("#uploadFileForm").submit(function(){filesList=
$('input#fileUpload[type="file"]').prop("files");0==filesList.length?dia.error("Please select a file to upload."):($("#fileUpload").fileupload(),$("#fileUpload").fileupload("add",{files:filesList,url:directory+"api/editFile.php?"+$.param({_action:"create",uploadMethod:"put",dataEncode:"binary",roomId:window.roomId,fileName:filesList.item(0).name,access_token:window.sessionHash,parentalAge:$("form#uploadFileForm select[name=parentalAge] option:selected").val(),parentalFlags:$("form#uploadFileForm input[name=parentalFlags]:checked").map(function(){return $(this).attr("value")}).get()}),
type:"PUT",multipart:!1}),$("#fileUpload").fileupload("destroy"),$("#modal-insertDoc").modal("hide"));return!1}),$("#fileUpload").bind("change",function(){var f=new FileReader,g=new FileReader;console.log("FileReader triggered.");$("#imageUploadSubmitButton").attr("disabled","disabled").button({disabled:!0});0===this.files.length?dia.error("No files selected!"):1<this.files.length?dia.error("Too many files selected!"):(console.log("FileReader started."),a=this.files[0].name,b=this.files[0].size,d=
"",c=a.split("."),e=c[c.length-1],e in serverSettings.fileUploads.extensionChanges&&(e=serverSettings.fileUploads.extensionChanges[e]),-1===$.inArray(e,$.toArray(serverSettings.fileUploads.allowedExtensions))?$("#uploadFileFormPreview").html($l("uploadErrors.badExtPersonal")):b>serverSettings.fileUploads.sizeLimits[e]?$("#uploadFileFormPreview").html($l("uploadErrors.tooLargePersonal",{fileSize:serverSettings.fileUploads.sizeLimits[e]})):($("#uploadFileFormPreview").html("Loading Preview..."),f.readAsBinaryString(this.files[0]),
f.onloadend=function(){d=window.btoa(f.result);md5.hex_md5(d)},g.readAsDataURL(this.files[0]),g.onloadend=function(){$("#uploadFileFormPreview").html(fim_messagePreview(serverSettings.fileUploads.fileContainers[e],this.result))},$("#imageUploadSubmitButton").removeAttr("disabled").button({disabled:!1})))}))):$("#insertDocUpload").html("Disabled.");return!1};
popup.prototype.viewStats=function(){$("#modal-stats").modal();$("table#viewStats > tbody").html("");for(i=1;10>=i;i+=1)$("table#viewStats > tbody").append("<tr><th>"+i+"</th></tr>");fimApi.getStats({roomId:window.roomId},{each:function(a){$("table#viewStats > thead > tr").append($("<th>").append($("<span>").attr({"class":"roomName","data-roomId":a.id}).text(a.name)));var b=0;jQuery.each(a.users,function(a,c){$("table#viewStats > tbody > tr").eq(b).append($("<td>").append(fim_buildUsernameTag($("<span>"),
c.id,fim_getUsernameDeferred(c.id),!0),$("<span>").text("("+c.messageCount+")")));b++})},end:function(){windowDraw()}})};
popup.prototype.settings={init:function(){var a={disableFormatting:16,disableImage:32,disableVideos:64,reversePostOrder:1024,showAvatars:2048,audioDing:8192,disableFx:262144,disableRightClick:1048576,usTime:16777216,twelveHourTime:33554432,webkitNotifications:536870912};fimApi.getUsers({info:["self","profile"],id:userId},{each:function(a){console.log(a);var b=[];b={r:0,g:0,b:0};var c=[];c={r:0,g:0,b:0};new autoEntry($("#ignoreListContainer"),{name:"ignoreList","default":a.ignoredUsers,list:"users",
resolveFromIds:Resolver.resolveUsersFromIds,resolveFromNames:Resolver.resolveUsersFromNames});new autoEntry($("#friendsListContainer"),{name:"friendsList","default":a.friendedUsers,list:"users",resolveFromIds:Resolver.resolveUsersFromIds,resolveFromNames:Resolver.resolveUsersFromNames});new autoEntry($("#watchRoomsContainer"),{name:"watchRooms","default":a.watchRooms,list:"rooms",resolveFromIds:Resolver.resolveRoomsFromIds,resolveFromNames:Resolver.resolveRoomsFromNames});$("#fontPreview").attr("style",
a.messageFormatting);defaultFormatting=a.messageFormatting.split(";");defaultFormattingObj={};jQuery.each(defaultFormatting,function(a,b){pair=b.split(":");defaultFormattingObj[pair[0]]=pair[1]});a.profile&&$("#profile").val(a.profile);"font-weight"in defaultFormattingObj&&"bold"==defaultFormattingObj["font-weight"]&&($("#fontPreview").css("font-weight","bold"),$("#defaultBold").attr("checked","checked"));$("#defaultBold").change(function(){$("#defaultBold").is(":checked")?$("#fontPreview").css("font-weight",
"bold"):$("#fontPreview").css("font-weight","normal")});"font-style"in defaultFormattingObj&&"italic"==defaultFormattingObj["font-style"]&&$("#defaultItalics").attr("checked","checked");$("#defaultItalics").change(function(){$("#defaultItalics").is(":checked")?$("#fontPreview").css("font-style","italic"):$("#fontPreview").css("font-style","normal")});window.serverSettings.formatting.fonts?(jQuery.each(window.serverSettings.formatting.fonts,function(a,b){$("#defaultFace").append($("<option>").attr({value:a,
style:"font-family: "+b}).attr(defaultFormattingObj["font-family"]==b?{selected:"selected"}:{}).text(a))}),$("#defaultFace").change(function(){$("#fontPreview").css("fontFamily",$("#defaultFace > option:selected").attr("data-font"))})):$("#defaultFace").hide();window.serverSettings.formatting.color?("color"in defaultFormattingObj&&($("#defaultColour").css("background-color",defaultFormattingObj.color),c=defaultFormattingObj.color.slice(4,-1).split(","),c={r:c[0],g:c[1],b:c[2]}),$("#defaultColour").ColorPicker({color:c,
onShow:function(a){$(a).fadeIn(500)},onHide:function(a){$(a).fadeOut(500)},onChange:function(a,b,d){defaultColour=d.r+","+d.g+","+d.b;$("#defaultColour").css("background-color","rgb("+defaultColour+")");$("#fontPreview").css("color","rgb("+defaultColour+")")}})):$("#defaultColour").hide();window.serverSettings.formatting.highlight?("background-color"in defaultFormattingObj&&($("#defaultHighlight").css("background-color",defaultFormattingObj["background-color"]),b=defaultFormattingObj["background-color"].slice(4,
-1).split(","),b={r:b[0],g:b[1],b:b[2]}),$("#defaultHighlight").ColorPicker({color:b,onShow:function(a){$(a).fadeIn(500)},onHide:function(a){$(a).fadeOut(500)},onChange:function(a,b,d){defaultHighlight=d.r+","+d.g+","+d.b;$("#defaultHighlight").css("background-color","rgb("+defaultHighlight+")");$("#fontPreview").css("background-color","rgb("+defaultHighlight+")")}})):$("#defaultHighlight").hide();fimApi.getRooms({roomIds:[a.defaultRoomId]},{each:function(a){$("#defaultRoom").val(a.name).attr("data-id",
a.id)}});window.serverSettings.parentalControls.parentalEnabled?(jQuery.each(window.serverSettings.parentalControls.parentalAges,function(a,b){$("#changeSettingsForm select[name=parentalAge]").append($("<option>").attr("value",b).text($l("parentalAges."+b)))}),jQuery.each(window.serverSettings.parentalControls.parentalFlags,function(a,b){$("#changeSettingsForm [name=parentalFlagsList]").append($("<label>").attr("class","btn btn-secondary m-1").text($l("parentalFlags."+b)).prepend($("<input>").attr({type:"checkbox",
value:b,name:"parentalFlags"})))}),jQuery.each(a.parentalFlags,function(a,b){$("input[name=parentalFlags][value="+b+"]").attr("checked",!0)})):$("#settings5parentalAge, #settings5parentalFlags").hide();$('input[name=privacyLevel][value="'+a.privacyLevel+'"]').prop("checked",!0)}});"vanilla"!==window.serverSettings.branding.forumType&&$("#settings5profile").hide(0);$("#defaultRoom").autocompleteHelper("rooms");window.webproDisplay.theme&&$('#theme > option[value="'+window.webproDisplay.theme+'"]').attr("selected",
"selected");$("#theme").change(function(){$("#stylesjQ").attr("href","client/css/"+this.value+"/jquery-ui-1.8.16.custom.css");$("#stylesVIM").attr("href","client/css/"+this.value+"/fim.css");$.cookie("webpro_theme",this.value,{expires:14});window.webproDisplay.theme=this.value;return!1});window.webproDisplay.fontSize&&$('#fontsize > option[value="'+window.webproDisplay.fontSize+'"]').attr("selected","selected");$("#fontsize").change(function(){$("body").css("font-size",this.value+"em");$.cookie("webpro_fontsize",
this.value,{expires:14});window.webproDisplay.fontSize=this.value;windowResize();return!1});snd.volume&&$("#audioVolume").attr("value",100*snd.volume);$("#audioVolume").change(function(){$.cookie("webpro_audioVolume",this.value,{expires:14});snd.volume=this.value/100;return!1});settings.showAvatars&&$("#showAvatars").attr("checked","checked");settings.reversePostOrder&&$("#reversePostOrder").attr("checked","checked");settings.disableFormatting&&$("#disableFormatting").attr("checked","checked");settings.disableVideo&&
$("#disableVideo").attr("checked","checked");settings.disableImage&&$("#disableImage").attr("checked","checked");$("#showAvatars, #reversePostOrder, #disableFormatting, #disableVideo, #disableImage").change(function(){var b=$(this).attr("id");$(this).is(":checked")&&!settings[b]?(settings[b]=!0,$("#messageList").html(""),$.cookie("webpro_settings",Number($.cookie("webpro_settings"))+a[b],{expires:14})):!$(this).is(":checked")&&settings[b]&&(settings[b]=!1,$("#messageList").html(""),$.cookie("webpro_settings",
Number($.cookie("webpro_settings"))-a[b],{expires:14}));standard.changeRoom(window.roomId)});settings.audioDing&&$("#audioDing").attr("checked","checked");settings.disableFx&&$("#disableFx").attr("checked","checked");settings.disableRightClick&&$("#disableRightClick").attr("checked","checked");settings.webkitNotifications&&$("#webkitNotifications").attr("checked","checked");$("#audioDing, #disableFx, #webkitNotifications, #disableRightClick").change(function(){var b=$(this).attr("id");$(this).is(":checked")&&
!settings[b]?(settings[b]=!0,$.cookie("webpro_settings",Number($.cookie("webpro_settings"))+a[b],{expires:14}),"disableFx"===b&&(jQuery.fx.off=!0),"webkitNotifications"===b&&(notify.webkitNotifySupported()?notify.webkitNotifyRequest():dia.error("Notifications are not supported on your browser."))):!$(this).is(":checked")&&settings[b]&&(settings[b]=!1,$.cookie("webpro_settings",Number($.cookie("webpro_settings"))-a[b],{expires:14}),"disableFx"===b&&(jQuery.fx.off=!1))});$("#changeSettingsForm").submit(function(){var a=
[];$("#defaultBold").is(":checked")&&a.push("bold");$("#defaultItalics").is(":checked")&&a.push("italic");fimApi.editUserOptions("edit",{defaultFontface:$("#defaultFace option:selected").val(),defaultFormatting:a,defaultHighlight:"rgba(0, 0, 0, 0)"===$("#fontPreview").css("background-color")?null:$("#fontPreview").css("background-color").slice(4,-1),defaultColor:$("#fontPreview").css("color").slice(4,-1),defaultRoomId:$("#defaultRoom").attr("data-id"),watchRooms:$("#watchRooms").val().split(","),
ignoreList:$("#ignoreList").val().split(","),friendsList:$("#friendsList").val().split(","),profile:$("#profile").val(),parentalAge:$("form#changeSettingsForm select[name=parentalAge] option:selected").val(),parentalFlags:$("form#changeSettingsForm input[name=parentalFlags]:checked").map(function(){return $(this).attr("value")}).get(),privacyLevel:$("input[name=privacyLevel]:radio:checked").val()},{each:function(a){console.log(a)},end:function(){dia.info("Your settings have been updated successfully.");
$("#changeSettingsDialogue").empty().remove();$(".colorpicker").empty().remove()},error:function(a){errorsList=[];for(var b=0;b<a.responseJSON.editUserOptions.length;b++)errorsList.push("<li>"+b+": "+a.responseJSON.editUserOptions[b].exception.details+"</li>");dia.error("Some of your settings have been updated. However, the following values were unable to be processed:<ul>"+errorsList.join()+"</ul>")}});window.history.back();return!1});return!1}};
popup.prototype.uploads={init:function(){fimApi.getFiles({userIds:[window.userId]},{each:function(a){for(var b=[],d=0;d<a.parentalFlags.length;d++)a.parentalFlags[d]&&b.push($l("parentalFlags."+a.parentalFlags[d]));$("#viewUploadsBody").append($("<tr>").append($('<td align="center">').append($('<img style="max-width: 200px; max-height: 200px;" />').attr("src",directory+"file.php?"+$.param({sha256hash:a.sha256hash,thumbnailWidth:200,thumbnailHeight:200}))).append("<br />").append($("<span>").text(a.fileName))).append($('<td align="center">').text(a.fileSizeFormatted)).append($('<td align="center">').text($l("parentalAges."+
a.parentalAge)).append("<br />").append(b.join(", "))).append($('<td align="center">').append($("<button>").click(function(){fimApi.editUserOptions("edit",{avatar:serverSettings.installUrl+"file.php?sha256hash="+a.sha256hash+"&thumbnailWidth=200&thumbnailHeight=200"},{end:function(a){"avatar"in a?dia.error(a.avatar.string):dia.info("Your avatar has been updated. It will not appear in your old messages.")}})}).text("Set to Avatar"))))},end:function(){$("#viewUploadsBody img").load(windowDraw)}})}};
popup.prototype.editRoom={options:{roomId:0},init:function(a){for(i in a)this.options[i]=a[i];var b=this.options.roomId?"edit":"create";$("#allowPosting").change(function(){$(this).is(":checked")?($("#allowedUsersBridge, #allowedGroupsBridge").attr("disabled","disabled"),$("#allowedUsersBridge, #allowedGroupsBridge").next().attr("disabled","disabled")):($("#allowedUsersBridge, #allowedGroupsBridge").removeAttr("disabled"),$("#allowedUsersBridge, #allowedGroupsBridge").next().removeAttr("disabled"))});
moderatorsList=new autoEntry($("#moderatorsContainer"),{name:"moderators",list:"users",onAdd:function(a){"edit"===b&&fimApi.editRoomPermissionUser(roomId,a,["post","moderate","properties","grant"])},onRemove:function(a){"edit"===b&&fimApi.editRoomPermissionUser(roomId,a,["post"])},resolveFromIds:Resolver.resolveUsersFromIds,resolveFromNames:Resolver.resolveUsersFromNames});allowedUsersList=new autoEntry($("#allowedUsersContainer"),{name:"allowedUsers",list:"users",onAdd:function(a){"edit"===b&&fimApi.editRoomPermissionUser(roomId,
a,["post"])},onRemove:function(a){"edit"===b&&fimApi.editRoomPermissionUser(roomId,a,[])},resolveFromIds:Resolver.resolveUsersFromIds,resolveFromNames:Resolver.resolveUsersFromNames});allowedGroupsList=new autoEntry($("#allowedGroupsContainer"),{name:"allowedGroups",list:"groups",onAdd:function(a){"edit"===b&&fimApi.editRoomPermissionGroup(roomId,a,["post"])},onRemove:function(a){"edit"===b&&fimApi.editRoomPermissionGroup(roomId,a,[])},resolveFromIds:Resolver.resolveGroupsFromIds,resolveFromNames:Resolver.resolveGroupsFromNames});
serverSettings.parentalControls.parentalEnabled?(jQuery.each(window.serverSettings.parentalControls.parentalAges,function(a,b){$("#editRoomForm select[name=parentalAge]").append($("<option>").attr("value",b).text($l("parentalAges."+b)))}),jQuery.each(window.serverSettings.parentalControls.parentalFlags,function(a,b){$("#editRoomForm div[name=parentalFlagsList]").append($("<label>").attr("class","btn btn-secondary m-1").text($l("parentalFlags."+b)).prepend($("<input>").attr({type:"checkbox",value:b,
name:"parentalFlags"})))})):$("#editRoom1ParentalAge, #editRoom1ParentalFlags").remove();fimApi.getCensorLists({roomId:roomId?roomId:null,includeWords:0},{each:function(a){if(a.status)var b=a.status;else if("white"===a.listType)b="block";else if("black"===a.listType)b="unblock";else throw"Bad logic.";$("#censorLists").append($("<label>").attr("class","btn btn-secondary m-1").text(a.listName).prepend($("<input>").attr({type:"checkbox",name:"censorLists",value:a.listId}).attr(a.listOptions&2?{disabled:"disabled"}:
{}).attr("block"==b?{checked:"checked"}:{})))}});roomId&&fimApi.getRooms({id:roomId},{each:function(a){var b=[],d=[];jQuery.each(a.userPermissions,function(a,c){c.moderate&&c.properties&&c.grant&&d.push(a);c.post&&b.push(a)});allowedUsersList.displayEntries(b);moderatorsList.displayEntries(d);var f=[];jQuery.each(a.groupPermissions,function(a,b){b.post&&f.push(a)});allowedGroupsList.displayEntries(f);"view"in a.defaultPermissions&&$("#allowViewing").prop("checked",!0);"post"in a.defaultPermissions&&
$("#allowPosting").prop("checked",!0);$("#name").val(a.name);$("#allowOfficial").prop("checked",a.official);$("#allowHidden").prop("checked",a.hidden);jQuery.each(a.parentalFlags,function(a,b){$("#editRoomForm input[name=parentalFlags][value="+b+"]").prop("checked",!0)});$("#editRoomForm select[name=parentalAge] option[value="+a.parentalAge+"]").attr("selected","selected")}});$("#editRoomForm").submit(function(){console.log("allowed users",allowedUsersList,allowedUsersList.getList());var a=$("#name").val(),
c={},e={},f={};"create"===b&&(allowedUsersList.getList().forEach(function(a){e["+"+a]=["view","post"]}),moderatorsList.getList().forEach(function(a){e["+"+a]=["view","post","moderate"]}),allowedGroupsList.getList().forEach(function(a){f["+"+a]=["post"]}));$("input[name=censorLists]").each(function(){c[$(this).attr("value")]=$(this).is(":checked")?1:0});defaultPermissions=[];$("#allowViewing").is(":checked")&&defaultPermissions.push("view");$("#allowPosting").is(":checked")&&defaultPermissions.push("post");
fimApi.editRoom(roomId,b,{name:a,defaultPermissions:defaultPermissions,userPermissions:e,groupPermissions:f,parentalAge:$("#editRoomForm select[name=parentalAge] option:selected").val(),parentalFlags:$("input[name=parentalFlags]:checked").map(function(){return $(this).attr("value")}).get(),censorLists:c,official:$("#allowOfficial").is(":checked"),hidden:$("#allowHidden").is(":checked")},{end:function(a){dia.full({content:'The room has been created at the following URL: <br /><br /><form action="'+
currentLocation+"#room="+a.id+'" method="post"><input type="text" style="width: 300px;" value="'+currentLocation+"#room="+a.id+'" name="url" /></form>',title:"Room Created!",id:"editRoomResultsDialogue",width:600,buttons:{Open:function(){$("#editRoomResultsDialogue").dialog("close");standard.changeRoom(a.id);return!1},Okay:function(){$("#editRoomResultsDialogue").dialog("close");return!1}}});$("#editRoomDialogue").dialog("close")}});return!1});return!1}};
popup.prototype.privateRoom=function(){$("#modal-privateRoom").modal();$("#privateRoomForm input[name=userName]").autocompleteHelper("users");$("#privateRoomForm").submit(function(){console.log("form submitted");var a=$("#privateRoomForm input[name=userName]").val(),b=$("#privateRoomForm input[name=userName]").attr("data-id");whenUserIdAvailable=function(a){window.location.hash="#room=p"+[window.userId,a].join()};!b&&a?whenUserIdAvailable(b):a?$.when(Resolver.resolveUsersFromNames([a]).then(function(b){whenUserIdAvailable(b[a].id)})):
dia.error("Please enter a username.");return!1})};
popup.prototype.online=function(){$("#modal-online").modal();fimApi.getActiveUsers({},{refresh:6E4,begin:function(){$("#onlineUsers").html("")},each:function(a){var b=[];jQuery.each(a.rooms,function(a,c){b.length&&b.push($("<span>").text(", "));b.push($("<a>").attr("href",'"#room='+c.id).text(c.name))});$("#onlineUsers").append($("<tr>").append($("<td>").append(fim_buildUsernameTag($("<span>"),a.id,fim_getUsernameDeferred(a.id),!0))).append($("<td>").append(b)))}});$("#modal-online").on("hidden.bs.modal",
function(){fimApi.getActiveUsers({},{close:!0})})};
popup.prototype.manageKicks=function(a){var b={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"};dia.full({content:$t("manageKicks"),title:"Manage/View Kicked Users",width:1E3,oF:function(){fimApi.getKicks(a,{each:function(a){jQuery.each(a.kicks,function(c,d){console.log(d);$("#kickedUsers").append($("<tr>").append($("<td>").append($('<span class="userName userNameTable">').attr({"data-userId":a.userId,style:a.userNameFormat}).text(a.userName))).append($("<td>").append($('<span class="userName userNameTable">').attr({"data-userId":d.kickerId,
style:d.kickerNameFormat}).text(d.kickerName))).append($("<td>").append($('<span class="roomName roomNameTable">').attr({"data-roomId":d.roomId}).text(d.roomName))).append($("<td>").text(fim_dateFormat(d.set,b))).append($("<td>").text(fim_dateFormat(d.expires,b))).append($("<td>").append($("<button>").click(function(){standard.unkick(a.userId,d.roomId)}).text("Unkick"))))})},end:windowDraw})}})};
popup.prototype.kick=function(){dia.full({content:$t("kick"),title:"Kick User",id:"kickUserDialogue",width:500,oF:function(){$("#userName").autocompleteHelper("users");$("#roomNameKick").autocompleteHelper("rooms");$("#kickUserForm").submit(function(){var a=$("#kickUserForm > #userName").val(),b=$("#kickUserForm > #userName").attr("data-id"),d=$("#kickUserForm > #roomNameKick").val(),c=$("#kickUserForm > #roomNameKick").attr("data-id"),e=Math.floor(Number($("#kickUserForm > #time").val()*Number($("#kickUserForm > #interval > option:selected").attr("value")))),
f=!0,g=!0;d&&!c&&(f=$.when(Resolver.resolveUsersFromNames([a]).then(function(c){b=c[a].id})));d&&!c&&(g=$.when(Resolver.resolveRoomsFromNames([d]).then(function(a){c=a[d].id})));$.when(f,g).then(function(){standard.kick(b,c,e)});return!1})}});return!1};
popup.prototype.archive={options:{searchText:"",resultLimit:40,searchUser:0,firstMessage:null,page:0,roomId:0},messageData:{},init:function(a){var b=this;for(i in a)this.options[i]=a[i];this.options.roomId||(this.options.roomId=window.roomId);$("#active-view-archive form#archiveSearch input[name=searchText]").unbind("change").bind("change",function(){b.update("searchText",$(this).val());b.retrieve()});$("#active-view-archive form#archiveSearch input[name=searchUser]").unbind("change").bind("change",
function(){console.log("search user",$(this).attr("data-id"));b.update("searchUser",$(this).attr("data-id"));b.retrieve()}).autocompleteHelper("users");$("#active-view-archive button[name=archiveNext]").unbind("click").bind("click",function(){b.nextPage()});$("#active-view-archive button[name=archivePrev]").unbind("click").bind("click",function(){b.prevPage()});$("#active-view-archive button[name=export]").unbind("click").bind("click",function(){popup.exportArchive()});b.retrieve()},setRoom:function(a){this.options.roomId!=
a&&(this.options.roomId=a,this.retrieve())},setFirstMessage:function(a){this.options.firstMessage=a;this.options.lastMessage=null;this.retrieve()},setLastMessage:function(a){this.options.lastMessage=a;this.options.firstMessage=null;this.retrieve()},nextPage:function(){fim_atomicRemoveHashParameterSetHashParameter("firstMessage","lastMessage",$("#active-view-archive table.messageTable tr:last-child > td > span.messageText").attr("data-messageid"))},prevPage:function(){fim_atomicRemoveHashParameterSetHashParameter("lastMessage",
"firstMessage",$("#active-view-archive table.messageTable tr:first-child > td > span.messageText").attr("data-messageid"))},retrieve:function(){var a=this;fimApi.getMessages({roomId:a.options.roomId,userIds:[a.options.searchUser],messageTextSearch:a.options.searchText,messageIdStart:a.options.firstMessage,messageIdEnd:a.options.lastMessage,archive:1,page:a.options.page},{reverseEach:a.options.firstMessage?!0:!1,end:function(b){$("#active-view-archive table.messageTable > tbody").html("");$("#active-view-archive button[name=archivePrev]").prop("disabled",
!1);this.messageData={};jQuery.each(b,function(b,c){$("#active-view-archive table.messageTable > tbody").append(fim_messageFormat(c,"table").append($("<td>").append($('<a href="#archive#room='+a.options.roomId+"#lastMessage="+c.id+'">Show</a>'))));a.messageData[c.id]=c});2>b.length?(a.options.firstMessage&&$("#active-view-archive button[name=archivePrev]").prop("disabled",!0),a.options.lastMessage&&$("#active-view-archive button[name=archiveNext]").prop("disabled",!0)):(a.options.firstMessage&&$("#active-view-archive button[name=archiveNext]").prop("disabled",
!1),a.options.lastMessage&&$("#active-view-archive button[name=archivePage]").prop("disabled",!1))}})},update:function(a,b){this.options[a]=b}};
popup.prototype.exportArchive=function(){dia.full({id:"exportDia",content:'<form method="post" action="#" onsubmit="return false;" id="exportDiaForm">How would you like to export the data?<br /><br /><table align="center"><tr><td>Format</td><td><select id="exportFormat"><option value="bbcodetable">BBCode Table</option><option value="csv">CSV List (Excel, etc.)</option></select></td></tr><tr><td colspan="2" align="center"><button type="submit">Export</button></td></tr></table></form>',width:600});
$("#exportDiaForm").submit(function(){switch($("#exportFormat option:selected").val()){case "bbcodetable":var a="";$("#archiveMessageList").find("tr").each(function(){var b=$(this).find("td:eq(0) .userNameTable").text(),d=$(this).find("td:eq(1)").text(),c=$(this).find("td:eq(2)").text();for(i in[0,2]){switch(i){case 0:var e=b;break;case 2:e=c}var f=$(this).find("td:eq("+i+") > span"),g=f.css("color"),h=f.css("backgroundColor"),k=f.css("fontFamily"),l="bold"==f.css("fontWeight")?!0:!1,m="underline"==
f.css("textDecoration")?!0:!1;f="line-through"==f.css("textDecoration")?!0:!1;if(g||h||k)b='[span="'+(g?"color: "+g+";":"")+(h?"background-color: "+h+";":"")+(k?"font: "+k+";":"")+'"]'+b+"[/span]";l&&(b="[b]"+b+"[/b]");m&&(b="[u]"+b+"[/u]");f&&(b="[s]"+b+"[/s]");switch(i){case 1:b=e;break;case 3:c=e}}a+=b+"|"+d+"|"+c+"\n"});a='<textarea style="width: 100%; height: 1000px;">[table=head]User|Time|Message\n'+a+"[/table]</textarea>";break;case "csv":a="",$("#archiveMessageList").find("tr").each(function(){var b=
$(this).find("td:nth-child(1) .userNameTable").text(),d=$(this).find("td:nth-child(2)").text(),c=$(this).find("td:nth-child(3)").text();a+="'"+b+"', '"+d+"', '"+c+"'\n"}),a='<textarea style="width: 100%; height: 600px;">'+a+"</textarea>"}dia.full({id:"exportTable",content:a,width:"1000"});return!1})};
popup.prototype.room={options:{roomId:0,intervalPing:!1,lastEvent:0,lastMessage:0},init:function(a){var b=this;for(i in a)b.options[i]=a[i];$("#sendForm").bind("submit",function(){var a=$("textarea#messageInput").val();0===a.length?dia.error("Please enter your message."):(b.sendMessage(a),$("textarea#messageInput").val(""));return!1});$("#messageInput").onEnter(function(){$("#sendForm").submit();return!1});fimApi.getRooms({id:b.options.roomId,permLevel:"view"},{each:function(a){a.permissions.view?
a.permissions.post?b.enableSender():(dia.error("You are not allowed to post in this room. You will be able to view it, though."),b.disableSender()):(window.roomId=!1,window.location.hash="#rooms",dia.error("You have been restricted access from this room. Please select a new room."));a.permissions.view&&(window.roomId=a.id,$("#roomName").html(a.name),$("#topic").html(a.topic),b.populateMessages())}});fimApi.getActiveUsers({roomIds:[roomId]},{refresh:15E3,timerId:1,begin:function(){$("#activeUsers").html("<ul></ul>")},
each:function(a){$("#activeUsers > ul").append($("<li>").append(fim_buildUsernameTag($("<span>"),a.id,fim_getUsernameDeferred(a.id),!0)))}})},eventListener:function(){var a=this,b=new EventSource(directory+"stream.php?queryId="+a.options.roomId+"&streamType=room&lastEvent="+a.options.lastEvent+"&lastMessage="+a.options.lastMessage+"&access_token="+window.sessionHash),d=function(b){return function(c){c.id>a.options.lastEvent&&(a.options.lastEvent=c.id);b(JSON.parse(c.data))}};b.addEventListener("newMessage",
d(function(b){a.options.lastMessage=Math.max(a.options.lastMessage,b.id);fim_newMessage(a.options.roomId,Number(b.id),fim_messageFormat(b,"list"))}),!1);b.addEventListener("topicChange",d(function(a){$("#topic").html(a.param1);console.log("Event (Topic Change): "+a.param1)}),!1);b.addEventListener("deletedMessage",d(function(a){$("#message"+a.id).fadeOut()}),!1);b.addEventListener("editedMessage",d(function(b){0<$("#message"+b.id).length&&(b.userId=$("#message"+b.id+" .userName").attr("data-userid"),
b.time=$("#message"+b.id+" .messageText").attr("data-time"),fim_newMessage(a.options.roomId,Number(b.id),fim_messageFormat(b,"list")))}),!1)},getMessages:function(){var a=this;a.options.roomId?fimApi.getMessages({roomId:a.options.roomId},{autoId:!0,refresh:3E3,each:function(b){fim_newMessage(Number(a.options.roomId),Number(b.id),fim_messageFormat(b,"list"))},end:function(){window.requestSettings.serverSentEvents&&(fimApi.getMessages(null,{close:!0}),a.eventListener())}}):console.log("Not requesting messages; room undefined.");
return!1},populateMessages:function(){var a=this;$(document).ready(function(){$("#messageList").html("");window.requestSettings[a.options.roomId]={lastMessage:null,firstRequest:!0};messageIndex[a.options.roomId]=[];a.getMessages();a.options.intervalPing&&clearInterval(a.options.intervalPing);fimApi.ping(a.options.roomId);a.options.intervalPing=window.setInterval(function(){fimApi.ping(a.options.roomId)},3E5);windowDraw();windowDynaLinks()})},sendMessage:function(a,b,d){var c=this;c.options.roomId?
fimApi.sendMessage(c.options.roomId,{ignoreBlock:1===b?1:"",message:a,flag:d?d:""},{end:function(a){"censor"in a&&0<Object.keys(a.censor).length&&dia.info(Object.values(a.censor).join("<br /><br />"),"Censor warning: "+Object.keys(a.censor).join(", "))},exception:function(b){"confirmCensor"===b.string?dia.confirm({text:b.details,"true":function(){c.sendMessage(a,1,d)}},"Censor Warning"):"spaceMessage"===b.string?dia.error("Too... many... spaces!"):fimApi.getDefaultExceptionHandler()(b)},error:function(b){settings.reversePostOrder?
$("#messageList").append('Your message, "'+a+'", could not be sent and will be retried.'):$("#messageList").prepend('Your message, "'+a+'", could not be sent and will be retried.');window.setTimeout(function(){c.sendMessage(a)},5E3);return!1}}):window.location.hash="#rooms"},disableSender:function(){$("#messageInput").attr("disabled","disabled");$("#icon_url").button({disabled:!0});$("#icon_submit").button({disabled:!0});$("#icon_reset").button({disabled:!0})},enableSender:function(){$("#messageInput").removeAttr("disabled");
$("#icon_url").button({disabled:!1});$("#icon_submit").button({disabled:!1});$("#icon_reset").button({disabled:!1})}};
popup.prototype.rooms={options:{searchText:"",page:0},init:function(a){var b=this;for(i in a)b.options[i]=a[i];$("#permissionLevel, #roomNameSearchText, #active-view-rooms button").unbind("change");$("#roomNameSearchText").bind("change",function(){b.update("searchText",$(this).val());b.retrieve()});$("#active-view-rooms button[name=roomListNext]").bind("click",function(){b.nextPage()});$("#active-view-rooms button[name=roomListPrev]").bind("click",function(){b.prevPage()});b.retrieve()},retrieve:function(){$("#roomTableHtml").html("");
fimApi.getRooms({page:this.options.page},{each:function(a){$("#roomTableHtml").append($("<tr>").attr("id","room"+a.id).append($("<td>").append($("<a>").attr("href","#room="+a.id).text(a.name)),$("<td>").text(a.topic),$("<td>").append($('<div class="btn-toolbar" role="toolbar">').append(a.permissions.properties?$("<button>").attr({"class":"btn btn-secondary",title:"Edit Room"}).append($('<i class="fa fa-sliders"></i>')).click(function(){window.location.hash="#editRoom#room="+a.id}):"",a.permissions.properties?
$("<button>").attr({"class":"btn btn-danger",title:"Delete Room"}).append($('<i class="fa fa-trash"></i>')).click(function(){dia.confirm("Are you sure you want to delete this room?")&&standard.deleteRoom(a.id)}):"",$("<button>").attr({"class":"btn btn-secondary",title:"View History"}).append($('<i class="fa fa-history"></i>')).click(function(){window.location.hash="#archive#room="+a.id}),$("<button>").attr({"class":"btn btn-secondary",title:"Favourite Room"}).append($('<i class="fa fa-star" style="color: yellow;"></i>')),
$("<button>").attr({"data-toggle":"button","class":"btn btn-secondary"+(-1!==window.activeLogin.userData.watchRooms.indexOf(a.id)?" active":""),"aria-pressed":-1!==window.activeLogin.userData.watchRooms.indexOf(a.id)?"true":"false",title:"Get Notifications About New Messages in This Room"}).append($('<i class="fa fa-eye"></i>')).click(function(){-1===window.activeLogin.userData.watchRooms.indexOf(a.id)?(dia.info("You will now be notified of new messages made in this room."),window.activeLogin.userData.watchRooms.push(a.id),
fimApi.watchRoom(a.id),$(this).addClass("active")):(window.activeLogin.userData.watchRooms.remove(a.id),fimApi.unwatchRoom(a.id),$(this).removeClass("active"))})))))}})},nextPage:function(){$("#archivePrev").button({disabled:!1});this.options.page++;this.retrieve()},prevPage:function(){0!==this.options.page&&this.options.page--;0>=this.options.page&&$("#archivePrev").button({disabled:!0});this.retrieve()},update:function(a,b){this.options[a]=b}};
